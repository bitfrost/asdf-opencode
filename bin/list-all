#!/usr/bin/env bash

set -euo pipefail

releases_path="https://api.github.com/repos/anomalyco/opencode/releases"

# Build curl arguments as an array to avoid eval
curl_args=(--retry 10 --retry-delay 2 -sfS)
if [ -n "${GITHUB_API_TOKEN:-}" ]; then
  curl_args+=(-H "Authorization: token $GITHUB_API_TOKEN")
fi

next_link="${releases_path}?per_page=100&page=1"
all_versions=""

while [ -n "${next_link}" ]; do
  # Download releases page, capture headers separately
  header_file=$(mktemp)
  trap "rm -f '$header_file'" EXIT

  response=$(curl "${curl_args[@]}" -D "$header_file" "$next_link") || {
    rm -f "$header_file"
    exit 1
  }

  # Get versions from response
  versions=$(echo "$response" | grep '"tag_name"' | cut -d'"' -f4 | sed 's/^v//')
  all_versions="${versions}"$'\n'"${all_versions}"

  # Get next link from headers (safely parse Link header)
  next_link=""
  if grep -qi '^link:' "$header_file"; then
    # Extract URL marked as rel="next"
    next_link=$(grep -i '^link:' "$header_file" | sed -n 's/.*<\([^>]*\)>; rel="next".*/\1/p')
  fi

  rm -f "$header_file"
  trap - EXIT
done

# stolen from https://github.com/rbenv/ruby-build/pull/631/files#diff-fdcfb8a18714b33b07529b7d02b54f1dR942
sort_versions() {
  sed 'h; s/[+-]/./g; s/.p\([[:digit:]]\)/.z\1/; s/$/.z/; G; s/\n/ /' | \
    LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n -k 4,4n -k 5,5n | awk '{print $2}'
}

echo "$all_versions" | sort_versions | tr '\n' ' ' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
