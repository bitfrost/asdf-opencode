#!/usr/bin/env bash

releases_path=https://api.github.com/repos/sst/opencode/releases

cmd_prefix="curl --verbose --retry 10 --retry-delay 2 -s"
if [ -n "$GITHUB_API_TOKEN" ]; then
  cmd_prefix="$cmd_prefix -H 'Authorization: token $GITHUB_API_TOKEN'"
fi

next_link="${releases_path}?per_page=100&page=1"
all_versions=""

while [ -n "${next_link}" ]; do

  # Download releases page
  cmd="${cmd_prefix} \"${next_link}\""
  cmd_out=$(eval "${cmd}" 2>&1)

  # Get versions
  versions=$(echo "${cmd_out}" | grep "\"tag_name\":" | sed 's/^ *"tag_name"\: *"v\?\(.*\)", *$/\1/')
  all_versions="${versions}\n${all_versions}"

  # Get next link
  next_link=$(echo "${cmd_out}" | grep '< link: ' | sed 's/< link: <\(.*\)>; rel="next".*$/\1/')
  next_link=$(echo "${next_link}" | sed 's/^.*<\(.*\)$/\1/')

done

# stolen from https://github.com/rbenv/ruby-build/pull/631/files#diff-fdcfb8a18714b33b07529b7d02b54f1dR942
function sort_versions() {
  sed 'h; s/[+-]/./g; s/.p\([[:digit:]]\)/.z\1/; s/$/.z/; G; s/\n/ /' | \
    LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n -k 4,4n -k 5,5n | awk '{print $2}'
}

echo -e "${all_versions}" | sort_versions | tr '\n' ' ' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
